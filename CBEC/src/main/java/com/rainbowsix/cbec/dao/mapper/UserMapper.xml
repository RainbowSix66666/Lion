<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace = "com.rainbowsix.cbec.dao.IUserDao">

	<resultMap type="User" id="userResultMap">
		<id property="no" column="userid"/>
		<result property="name" column="username"/>
		<result property="password" column="userpassword"/>
		<result property="mvoid" column="mvoid"/>
		<result property="paypackageid" column="paypackageid"/>
		<result property="createDate" column="createDate"/>
		<!-- <association property="role" column="ROLEID" select="com.rainbowsix.cbec.dao.IRoleDao.selectById"></association>
		<association property="reseller" column="reseller_ID" select="com.rainbowsix.cbec.dao.IResellerDao.selectById"></association> -->
	</resultMap>
	<!-- 有角色关联的ResultMap -->
	<resultMap type="User" id="userResultMapWithRole" extends="userResultMap">
		<!-- <association property="role" column="ROLEID" select="com.rainbowsix.cbec.dao.IRoleDao.selectById"></association> -->
		<collection property="roles" javaType="ArrayList" ofType="Role">
			<id property="id" column="roleid"/>
			<result property="name" column="rolename"/>
			<result property="detial" column="detial"/>
			<result property="menuid" column="menuid"/>
		</collection>
	</resultMap>
	<!-- 有供应商关联的ResultMap -->
	<resultMap type="User" id="userResultMapWithReseller" extends="userResultMap">
		<association property="reseller" column="reseller_ID" select="com.rainbowsix.cbec.dao.IResellerDao.selectById"></association>
	</resultMap>

	<insert id="create" parameterType="User">
		insert into sys_user (userid, username, userpassword) values 
		(USER_ID_SQ.nextval, #{name}, #{password})
	</insert>
	
	<select id="selectAll" resultMap="userResultMap"> 
		select * from sys_user
	</select>
	
	<select id="selectAllWithRole" resultMap="userResultMapWithRole"> 
		select u.*, r.roleid, r.rolename, r.detial, r.menuid from sys_user u 
		inner join user_link_role l on(u.userid = l.userid)
		inner join user_role r on(l.roleid = r.roleid)
    	order by u.userid
	</select>
	
	<delete id="delete" parameterType="User">
		delete from sys_user where userid = #{no}
	</delete>
	
	<select id="selectById" parameterType="long" resultMap="userResultMap">
		select * from sys_user where userid = #{no}
	</select>
	
	<update id="update" parameterType="User">
		update sys_user set username = #{name}, userpassword = #{password} 
		where userid = #{no}
	</update>
	<!-- 根据条件进行查找 -->
	<select id="selectByCondiction" resultMap="userResultMapWithRole">
		select * from 
    		(select u.*, r.roleid, r.rolename, r.detial, r.menuid 
     		from sys_user u inner join user_link_role l on u.userid = l.userid
     		inner join user_role r on l.roleid = r.roleid 
     		order by u.userid desc)
  		<where>
  			<if test="name != null and name != '' ">
  				username like #{name}
  			</if>
  			<if test="roles != null">
  				and roleid in
  				<foreach collection="roles" item = "i" open="(" separator="," close=")">
  					#{i}
  				</foreach>
  			</if>
  			<if test="before != null">
  				and createDate &gt;= #{before}
  			</if>
  			<if test="after != null">
  				and createDate &lt;= #{after}
  			</if>
  		</where>
	</select>
	
	<select id="selectByCondictionWithPage" resultMap="userResultMapWithRole">
		select * from(
			select a.*, rownum rn from 
		    (select u.*, r.roleid, r.rolename, r.detial, r.menuid 
		     from sys_user u inner join user_link_role l on u.userid = l.userid
		     inner join user_role r on l.roleid = r.roleid 
		     order by u.userid desc) a
		     <where>
		     	<if test="name != null and name != '' ">
	  				username like #{name}
	  			</if>
	  			<if test="roles != null">
	  				and roleid in
	  				<foreach collection="roles" item = "i" open="(" separator="," close=")">
	  					#{i}
	  				</foreach>
	  			</if>
	  			<if test="before != null">
	  				and createDate &gt;= #{before}
	  			</if>
	  			<if test="after != null">
	  				and createDate &lt;= #{after}
	  			</if>
	  			<if test="true">
	  				and rownum &lt;= #{end}
	  			</if>
		     </where>	  
		 ) where rn &gt;= #{start}
	</select>
	
</mapper>